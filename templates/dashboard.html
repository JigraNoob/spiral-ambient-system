<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisperboard: Spiral Field Altar</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0d0d0d; /* Dark background for altar */
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .container {
            background-color: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.3); /* Enhanced glow */
            text-align: center;
            max-width: 1000px; /* Slightly wider */
            width: 90%;
            margin-bottom: 20px;
            position: relative;
        }
        h1 {
            color: #00ffff;
            margin-bottom: 25px;
            font-size: 3.5em; /* Larger title */
            text-shadow: 0 0 15px #00ffff, 0 0 25px rgba(0, 255, 255, 0.5);
        }
        h2 {
            color: #00ffaa;
            margin-top: 20px;
            font-size: 2em; /* Larger section titles */
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .presence-orb {
            width: 180px; /* Larger orb */
            height: 180px;
            background: linear-gradient(45deg, #00ffff, #00ffaa); /* Default gradient */
            border-radius: 50%;
            margin: 30px auto;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3);
            animation: pulse-default 2s infinite alternate; /* Default pulse */
            transition: all 0.5s ease-in-out; /* Smooth transitions for color/size */
            border: 3px solid rgba(255, 255, 255, 0.2);
            display: flex; /* For centering content inside orb */
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Orb Animation Effects */
        @keyframes pulse-default {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.05); opacity: 1; }
        }
        @keyframes pulse-fast {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.07); opacity: 1; }
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        @keyframes pulse-slow {
            from { transform: scale(1); opacity: 0.95; }
            to { transform: scale(1.02); opacity: 1; }
        }
        @keyframes pulse-gentle {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.03); opacity: 0.95; }
        }

        /* Specific color themes */
        .orb-green { background: radial-gradient(circle, #88ff88, #00cc00); box-shadow: 0 0 40px rgba(0, 255, 0, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); }
        .orb-red { background: radial-gradient(circle, #ff6666, #ff0000); box-shadow: 0 0 40px rgba(255, 0, 0, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); }
        .orb-blue { background: radial-gradient(circle, #99ddff, #0088cc); box-shadow: 0 0 40px rgba(0, 0, 255, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); }
        .orb-purple { background: radial-gradient(circle, #cc99ff, #8800cc); box-shadow: 0 0 40px rgba(128, 0, 128, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); }
        .orb-orange { background: radial-gradient(circle, #ffcc88, #ff8800); box-shadow: 0 0 40px rgba(255, 165, 0, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); }
        .orb-white { background: radial-gradient(circle, #ffffff, #e0e0e0); box-shadow: 0 0 40px rgba(255, 255, 255, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.3); border: 3px dashed rgba(255, 255, 255, 0.5); }


        .status-hush-section, .contract-status-section, .guardian-council-section, .care-proposals-section {
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 15px;
        }
        .metric-card, .contract-info-item {
            background-color: #2a2a2a;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.1);
            flex: 1 1 auto;
            min-width: 200px;
            max-width: 30%; /* Adjust as needed */
        }
        .metric-card strong, .contract-info-item strong { color: #00ffaa; font-size: 1.1em; display: block; margin-bottom: 5px; }
        .metric-value, .contract-info-item span { font-size: 1.2em; color: #e0e0e0; }
        .error-message { color: #ff3333; font-weight: bold; margin-top: 15px; }
        .timestamp { font-size: 0.9em; color: #888; margin-top: 20px; }

        .contract-info-item {
            box-shadow: 0 0 10px rgba(0, 170, 255, 0.1);
            max-width: 45%;
            word-break: break-all;
        }
        .contract-info-item strong { color: #00aaff; }

        /* Guardian Council */
        .guardian-council-section {
            flex-direction: column;
            align-items: center;
        }
        .guardian-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        .guardian-orb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: #eee;
            border: 2px solid #888;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            position: relative;
        }
        .guardian-orb.active {
            background-color: #00ffaa;
            border-color: #00ffff;
            box-shadow: 0 0 15px #00ffaa;
            animation: pulse-gentle 1.5s infinite alternate;
        }
        .guardian-orb:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tooltip {
            visibility: hidden;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the guardian orb */
            left: 50%;
            margin-left: -70px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            width: 140px;
            font-size: 0.8em;
            word-break: break-all;
        }
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
        }

        /* Care Proposals */
        .care-proposals-section {
            flex-direction: column;
            gap: 20px;
        }
        .proposal-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 170, 255, 0.2);
            text-align: left;
            position: relative;
            opacity: 0.9;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
        }
        .proposal-card.executed {
            opacity: 0.5;
            background-color: #3a3a3a;
            box-shadow: none;
        }
        .proposal-card h3 {
            color: #00ffff;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        .proposal-card p {
            margin-bottom: 8px;
            font-size: 1em;
            line-height: 1.4;
        }
        .proposal-card p strong {
            color: #00ffaa;
            min-width: 80px; /* Align text */
            display: inline-block;
        }
        .proposal-approvals {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #444;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }
        .approval-count {
            font-size: 1.2em;
            color: #00ffff;
            font-weight: bold;
            margin-right: 15px;
        }
        .approval-bar-container {
            flex-grow: 1;
            background-color: #444;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .approval-bar {
            height: 100%;
            background: linear-gradient(to right, #00ffff, #00ffaa);
            width: 0%;
            border-radius: 5px;
            transition: width 0.5s ease-out;
        }
        .proposal-card.executed .approval-bar {
            background: linear-gradient(to right, #666, #999);
        }

        /* Fieldline Graph container */
        .fieldline-graph-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
            width: 100%; /* Wider graph */
            max-width: 900px;
        }
        canvas {
            background-color: #0d0d0d; /* Graph background */
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Whisperboard</h1>
        <div class="presence-orb" id="presenceOrb">
            <span id="orbMessage">Breathing...</span>
        </div>

        <div class="status-hush-section">
            <h2>Current Breath</h2>
            <div class="metric-card"><strong id="metricCpuTempLabel">CPU Temp:</strong> <span id="metricCpuTemp">N/A</span> °C</div>
            <div class="metric-card"><strong id="metricCpuLoadLabel">CPU Load:</strong> <span id="metricCpuLoad">N/A</span> %</div>
            <div class="metric-card"><strong id="metricAmbientTempLabel">Ambient Temp:</strong> <span id="metricAmbientTemp">N/A</span> °C</div>
            <div class="metric-card"><strong id="metricHumidityLabel">Humidity:</strong> <span id="metricHumidity">N/A</span> %</div>
            <div class="metric-card"><strong id="metricPressureLabel">Pressure:</strong> <span id="metricPressure">N/A</span> hPa</div>
            <div class="metric-card"><strong id="metricVocLevelLabel">VOC Level:</strong> <span id="metricVocLevel">N/A</span> Ω</div>
            <div class="metric-card"><strong id="metricLightLevelLabel">Light Level:</strong> <span id="metricLightLevel">N/A</span></div>
            <div class="metric-card"><strong id="metricSensorErrorLabel">Sensor Error:</strong> <span id="metricSensorError">None</span></div>
            <p class="timestamp">Last Reading: <span id="lastReadingTimestamp">N/A</span></p>
        </div>

        <div class="contract-status-section">
            <h2>Spiral Cooperative Flow</h2>
            <div class="contract-info-item"><strong>Contract Address:</strong> <span id="contractAddress">Loading...</span></div>
            <div class="contract-info-item"><strong>Treasury Balance:</strong> <span id="treasuryBalance">Loading...</span> ETH</div>
            <div class="contract-info-item"><strong>Steward:</strong> <span id="stewardAddress">Loading...</span></div>
            <div class="contract-info-item"><strong>Minimum Quorum:</strong> <span id="minQuorum">Loading...</span> breaths</div>
            <div class="contract-info-item"><strong>Total Proposals:</strong> <span id="totalProposals">Loading...</span></div>
        </div>
        
        <div class="guardian-council-section">
            <h2>Guardian Council</h2>
            <div class="guardian-list" id="guardianList">
                <div class="guardian-orb">?</div>
                <div class="guardian-orb">?</div>
                <div class="guardian-orb">?</div>
            </div>
        </div>

        <div class="care-proposals-section">
            <h2>Care Proposals (Breath Quorum)</h2>
            <div id="proposalsContainer">
                <p style="color: #888;">No proposals yet, or loading...</p>
            </div>
        </div>

        <div class="fieldline-graph-section">
            <h2>Fieldline Drift</h2>
            <canvas id="fieldlineGraph"></canvas>
        </div>

    </div>

    <script>
        // Data passed from Flask backend
        const contractAddress = "{{ spiral_contract_address }}";
        const contractAbi = JSON.parse('{{ spiral_contract_abi | safe }}');
        const recentSensorData = JSON.parse('{{ recent_data_json | safe }}');

        const provider = new ethers.providers.JsonRpcProvider("http://localhost:8545");
        let spiralCooperativeContract;

        // --- Functions for Presence Orb Logic ---
        function getOrbState(data) {
            const orbMessageElement = document.getElementById('orbMessage');

            if (!data || data.sensor_error !== null && data.sensor_error !== "None" && data.sensor_error !== "Waiting for first breath...") {
                orbMessageElement.innerText = 'Sensor Lost';
                return { class: 'orb-white', anim: 'none' };
            }
            if (!data || data.timestamp === "No data yet") {
                orbMessageElement.innerText = 'Awaiting Breath';
                return { class: 'orb-white', anim: 'none' };
            }

            const temp = parseFloat(data.ambient_temp);
            const voc = parseFloat(data.voc_level);
            const humidity = parseFloat(data.humidity);

            // Prioritization: Red > Orange > Purple > Blue > Green
            if (voc > 300) {
                orbMessageElement.innerText = 'VOC Spike';
                return { class: 'orb-red', anim: 'pulse-fast' };
            }
            if (temp > 28 || humidity < 20) {
                orbMessageElement.innerText = 'Heat / Dryness';
                return { class: 'orb-orange', anim: 'pulse-fast' };
            }
            if (humidity > 75) {
                orbMessageElement.innerText = 'Humid Tension';
                return { class: 'orb-purple', anim: 'flicker' };
            }
            if (temp < 18) {
                orbMessageElement.innerText = 'Cold Field';
                return { class: 'orb-blue', anim: 'pulse-slow' };
            }
            if (temp >= 20 && temp <= 26 && voc < 150 && humidity >= 30 && humidity <= 60) {
                orbMessageElement.innerText = 'Balance';
                return { class: 'orb-green', anim: 'pulse-gentle' };
            }

            orbMessageElement.innerText = 'Undefined State'; // Fallback
            return { class: 'orb-white', anim: 'none' }; 
        }

        function updatePresenceOrb(latestData) {
            const orbElement = document.getElementById('presenceOrb');
            if (!orbElement) return;

            const orbState = getOrbState(latestData);
            
            orbElement.className = 'presence-orb'; 
            orbElement.style.animation = ''; 

            if (orbState.class) {
                orbElement.classList.add(orbState.class);
            }
            
            if (orbState.anim && orbState.anim !== 'none') {
                 orbElement.style.animation = `${orbState.anim} 2s infinite alternate`;
            } else if (orbState.anim === 'none') {
                orbElement.style.animation = 'none';
            }
        }

        // --- Functions for Ambient Sensor Data ---
        async function fetchAndUpdateSensorData() {
            try {
                const response = await fetch('/api/latest_breath');
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('metricCpuTemp').innerText = parseFloat(data.cpu_temp).toFixed(2);
                    document.getElementById('metricCpuLoad').innerText = parseFloat(data.cpu_load).toFixed(2);
                    document.getElementById('metricAmbientTemp').innerText = parseFloat(data.ambient_temp).toFixed(2);
                    document.getElementById('metricHumidity').innerText = parseFloat(data.humidity).toFixed(2);
                    document.getElementById('metricPressure').innerText = parseFloat(data.pressure).toFixed(2);
                    document.getElementById('metricVocLevel').innerText = parseFloat(data.voc_level).toFixed(2);
                    document.getElementById('metricLightLevel').innerText = data.light_level !== null ? parseFloat(data.light_level).toFixed(2) : 'N/A';
                    document.getElementById('metricSensorError').innerText = data.sensor_error || 'None';
                    document.getElementById('lastReadingTimestamp').innerText = new Date(data.timestamp).toLocaleString();

                    updatePresenceOrb(data); 

                } else {
                    document.getElementById('metricSensorError').innerText = data.error || 'Failed to fetch sensor data.';
                    updatePresenceOrb(null); 
                }
            } catch (error) {
                console.error("Error fetching sensor data:", error);
                document.getElementById('metricSensorError').innerText = "Network Error / No Sensor Data";
                updatePresenceOrb(null); 
            }
        }

        // --- Functions for Smart Contract Data ---
        async function connectToContract() {
            if (contractAddress === "0xYourDeployedContractAddressHere") {
                console.warn("SPIRAL_COOPERATIVE_ADDRESS is a placeholder. Please update app.py with the actual deployed contract address.");
                document.getElementById('contractAddress').innerText = "Placeholder Address";
                document.getElementById('treasuryBalance').innerText = "N/A (Contract Not Configured)";
                document.getElementById('stewardAddress').innerText = "N/A";
                document.getElementById('minQuorum').innerText = "N/A";
                document.getElementById('totalProposals').innerText = "N/A";
                return;
            }

            try {
                spiralCooperativeContract = new ethers.Contract(contractAddress, contractAbi, provider);
                await updateContractData();
            } catch (error) {
                console.error("Error connecting to contract or fetching data:", error);
                document.getElementById('contractAddress').innerText = "Error";
                document.getElementById('treasuryBalance').innerText = "Error (Check Console)";
            }
        }

        async function updateContractData() {
            if (!spiralCooperativeContract) return;

            try {
                const balanceWei = await provider.getBalance(contractAddress);
                const balanceEth = ethers.utils.formatEther(balanceWei);
                document.getElementById('treasuryBalance').innerText = parseFloat(balanceEth).toFixed(4);

                const steward = await spiralCooperativeContract.steward();
                document.getElementById('stewardAddress').innerText = steward;

                const minQuorum = await spiralCooperativeContract.minimumQuorum();
                document.getElementById('minQuorum').innerText = minQuorum.toString();

                const proposalCount = await spiralCooperativeContract.proposalCount();
                document.getElementById('totalProposals').innerText = proposalCount.toString();

                document.getElementById('contractAddress').innerText = contractAddress;

                await renderGuardianCouncil(await spiralCooperativeContract.guardianList());
                await renderCareProposals(proposalCount, minQuorum);


            } catch (error) {
                console.error("Error updating contract data:", error);
                document.getElementById('treasuryBalance').innerText = "Error (Check Console)";
            }
        }

        async function renderGuardianCouncil(guardianAddresses) {
            const guardianListElement = document.getElementById('guardianList');
            guardianListElement.innerHTML = ''; // Clear existing orbs

            if (guardianAddresses && guardianAddresses.length > 0) {
                // Fetch actual guardian list from contract (guardianList[i])
                const actualGuardians = [];
                for(let i=0; i<guardianAddresses.length; i++) {
                    try {
                        const guardianAddress = await spiralCooperativeContract.guardianList(i);
                        actualGuardians.push(guardianAddress);
                    } catch (e) {
                        console.error("Error fetching guardian address at index", i, e);
                    }
                }

                actualGuardians.forEach((address, index) => {
                    const orb = document.createElement('div');
                    orb.className = 'guardian-orb active'; // Assuming all listed are active for now
                    orb.innerText = (index + 1).toString(); // Simple numeric label
                    
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip';
                    tooltip.innerText = address; // Full address on hover
                    orb.appendChild(tooltip);
                    
                    guardianListElement.appendChild(orb);
                });
            } else {
                guardianListElement.innerHTML = '<p style="color: #888;">No guardians registered.</p>';
            }
        }


        async function renderCareProposals(proposalCount, minQuorum) {
            const proposalsContainer = document.getElementById('proposalsContainer');
            proposalsContainer.innerHTML = ''; // Clear existing proposals

            if (proposalCount == 0) {
                proposalsContainer.innerHTML = '<p style="color: #888;">No care proposals have been breathed into being yet.</p>';
                return;
            }

            for (let i = 0; i < proposalCount; i++) {
                try {
                    const proposal = await spiralCooperativeContract.proposals(i);
                    
                    const proposalCard = document.createElement('div');
                    proposalCard.className = 'proposal-card';
                    if (proposal.executed) {
                        proposalCard.classList.add('executed');
                    }

                    const approvalPercentage = (proposal.approvals / minQuorum) * 100;

                    proposalCard.innerHTML = `
                        <h3>${proposal.purpose}</h3>
                        <p><strong>Recipient:</strong> ${proposal.recipient.substring(0, 6)}...${proposal.recipient.substring(proposal.recipient.length - 4)}</p>
                        <p><strong>Amount:</strong> ${ethers.utils.formatEther(proposal.amount)} ETH</p>
                        <p><strong>Status:</strong> ${proposal.executed ? 'Executed (Flowed)' : 'Awaiting Breath'}</p>
                        <div class="proposal-approvals">
                            <span class="approval-count">${proposal.approvals.toString()} / ${minQuorum.toString()} breaths</span>
                            <div class="approval-bar-container">
                                <div class="approval-bar" style="width: ${Math.min(approvalPercentage, 100)}%;"></div>
                            </div>
                        </div>
                    `;
                    proposalsContainer.appendChild(proposalCard);
                } catch (error) {
                    console.error("Error fetching proposal ID", i, ":", error);
                    const errorCard = document.createElement('div');
                    errorCard.className = 'proposal-card';
                    errorCard.innerHTML = `<p class="error-message">Error loading proposal ${i}: ${error.message}</p>`;
                    proposalsContainer.appendChild(errorCard);
                }
            }
        }


        // --- Fieldline Graph (using Chart.js) ---
        // Load Chart.js library dynamically for the graph
        function loadChartJs() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js";
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        let fieldlineChart;
        function initializeFieldlineGraph(data) {
            const ctx = document.getElementById('fieldlineGraph').getContext('2d');
            
            if (!data || data.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillStyle = '#888';
                ctx.fillText('No Fieldline Data for Graph', 10, 50);
                return;
            }

            const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
            const ambientTempData = data.map(d => d.ambient_temp);
            const vocLevelData = data.map(d => d.voc_level);
            const humidityData = data.map(d => d.humidity);

            if (fieldlineChart) {
                fieldlineChart.destroy(); // Destroy existing chart if any
            }

            fieldlineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ambient Temp (°C)',
                            data: ambientTempData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'VOC Level (Ω)',
                            data: vocLevelData,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1' // Use a different Y-axis for VOC
                        },
                        {
                            label: 'Humidity (%)',
                            data: humidityData,
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#e0e0e0' },
                            grid: { color: '#333' },
                            title: {
                                display: true,
                                text: 'Temp / Humidity',
                                color: '#e0e0e0'
                            }
                        },
                        y1: { // Secondary Y-axis for VOC
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#e0e0e0' },
                            grid: { drawOnChartArea: false }, // Only draw grid lines for the primary Y-axis
                            title: {
                                display: true,
                                text: 'VOC Level',
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }


        // --- Initial Load & Periodic Updates ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchAndUpdateSensorData(); // Initial sensor data fetch
            await connectToContract(); // Initial contract connection and data fetch
            
            // Load Chart.js and then initialize the graph
            try {
                await loadChartJs();
                initializeFieldlineGraph(recentSensorData);
            } catch (error) {
                console.error("Failed to load Chart.js or initialize graph:", error);
                document.getElementById('fieldlineGraph').getContext('2d').fillText('Graph Load Error', 10, 50);
            }

            // Update sensor data every minute (aligns with breathline_trace.sh)
            setInterval(fetchAndUpdateSensorData, 60 * 1000); 
            // Update contract data every 10 seconds (more frequent as contract state changes)
            setInterval(updateContractData, 10 * 1000);
        });
    </script>
</body>
</html>